<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ユーザー・管理者 ログイン＆新規登録 ＆ 15ゲーム</title>
    <style>
        .form-section, .game-section, .home-screen, .game-screen { display: none; }
        .active, .visible { display: block; }
        .grid {
            display: grid;
            gap: 5px;
        }
        .tile {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #ddd;
            cursor: pointer;
        }
        .empty { background-color: #fff; cursor: default; }
    </style>
</head>
<body>
    <h1>ユーザー・管理者 ログイン＆新規登録 ＆ 15ゲーム</h1>

    <!-- メニュー -->
    <nav>
        <button onclick="showSection('login')">通常ログイン</button>
        <button onclick="showSection('register')">新規登録</button>
        <button onclick="showSection('adminLogin')">管理者ログイン</button>
        <button onclick="showSection('home-screen')">15ゲーム - 難易度選択</button>
    </nav>

    <!-- 通常ログインフォーム (デフォルト表示) -->
    <section id="login" class="form-section active">
        <h2>通常ログイン</h2>
        <form id="loginForm" onsubmit="loginUser(event)">
            <label for="loginUsername">ユーザー名：</label>
            <input type="text" id="loginUsername" name="username" required>
            <br><br>
            <label for="loginPassword">パスワード：</label>
            <input type="password" id="loginPassword" name="password" required>
            <br><br>
            <button type="submit">ログイン</button>
        </form>
        <div id="loginMessage"></div>
    </section>

    <!-- 新規登録フォーム -->
    <section id="register" class="form-section">
        <h2>新規登録</h2>
        <form id="registerForm" onsubmit="registerUser(event)">
            <label for="registerUsername">ユーザー名：</label>
            <input type="text" id="registerUsername" name="username" required>
            <br><br>
            <label for="registerPassword">パスワード：</label>
            <input type="password" id="registerPassword" name="password" required>
            <br><br>
            <label for="registerEmail">メールアドレス：</label>
            <input type="email" id="registerEmail" name="email" required>
            <br><br>
            <button type="submit">登録</button>
        </form>
        <div id="registerMessage"></div>
    </section>

    <!-- 管理者ログインフォーム -->
    <section id="adminLogin" class="form-section">
        <h2>管理者ログイン</h2>
        <form id="adminLoginForm" onsubmit="loginAdmin(event)">
            <label for="adminUsername">ユーザー名：</label>
            <input type="text" id="adminUsername" name="username" required>
            <br><br>
            <label for="adminPassword">パスワード：</label>
            <input type="password" id="adminPassword" name="password" required>
            <br><br>
            <button type="submit">ログイン</button>
        </form>
        <div id="adminLoginMessage"></div>
        <p>通常のログインはこちら：<a href="#" onclick="showSection('login')">ログイン画面</a></p>
    </section>

    <!-- ゲーム選択画面 -->
    <section id="home-screen" class="home-screen">
        <h2>15ゲーム - 難易度選択</h2>
        <button onclick="startGame(3)">簡単 (3x3)</button>
        <button onclick="startGame(4)">普通 (4x4)</button>
        <button onclick="startGame(5)">難しい (5x5)</button>
    </section>

    <!-- ゲーム画面 -->
    <section id="game-screen" class="game-screen">
        <h2>15ゲーム</h2>
        <div id="timer">経過時間: 00:00</div>
        <div id="puzzle" class="grid"></div>
        <button onclick="retry()">リトライ</button>
        <button onclick="goToHome()">難易度選択へ戻る</button>
    </section>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.form-section, .home-screen, .game-screen').forEach(section => section.classList.remove('active', 'visible'));
            document.getElementById(sectionId).classList.add('active');
        }

        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;

            const response = await fetch('register.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, email })
            });
            const result = await response.text();
            document.getElementById('registerMessage').innerText = result;
        }

        async function loginUser(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const response = await fetch('login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.text();
            document.getElementById('loginMessage').innerText = result;
        }

        async function loginAdmin(event) {
            event.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            const response = await fetch('admin_login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.text();
            document.getElementById('adminLoginMessage').innerText = result;
        }

        // 15パズルゲームの処理
        const homeScreen = document.getElementById('home-screen');
        const gameScreen = document.getElementById('game-screen');
        const puzzle = document.getElementById('puzzle');
        const timerElement = document.getElementById('timer');
        let timerInterval;
        let startTime;
        let gridSize;

        function startGame(size) {
            gridSize = size;
            puzzle.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            puzzle.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;
            createTiles();
            resetTimer();
            startTimer();
            homeScreen.classList.remove('visible');
            gameScreen.classList.add('visible');
        }

        function createTiles() {
            const tileCount = gridSize * gridSize - 1;
            const numbers = Array.from({ length: tileCount }, (_, i) => i + 1);
            numbers.push(null); // 空タイルを追加

            for (let i = numbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
            }

            puzzle.innerHTML = '';
            numbers.forEach(number => {
                const tile = document.createElement('div');
                tile.className = number ? 'tile' : 'tile empty';
                tile.textContent = number || '';
                tile.onclick = () => moveTile(tile);
                puzzle.appendChild(tile);
            });
        }

        function moveTile(tile) {
            const emptyTile = document.querySelector('.tile.empty');
            const tileIndex = Array.from(puzzle.children).indexOf(tile);
            const emptyIndex = Array.from(puzzle.children).indexOf(emptyTile);

            const rowDiff = Math.abs(Math.floor(tileIndex / gridSize) - Math.floor(emptyIndex / gridSize));
            const colDiff = Math.abs((tileIndex % gridSize) - (emptyIndex % gridSize));

            if (rowDiff + colDiff === 1) {
                [tile.textContent, emptyTile.textContent] = [emptyTile.textContent, tile.textContent];
                tile.classList.toggle('empty');
                emptyTile.classList.toggle('empty');
                checkCompletion();
            }
        }

        function checkCompletion() {
            const tiles = Array.from(puzzle.children);
            const isCompleted = tiles.slice(0, -1).every((tile, i) =>
            const isCompleted = tiles.slice(0, -1).every((tile, i) => tile.textContent == i + 1);
            if (isCompleted) {
                stopTimer();
                alert(`おめでとうございます！クリアしました！時間: ${timerElement.textContent}`);
                document.getElementById('retry-btn').style.display = 'block';
            }
        }

        function resetTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerElement.textContent = '経過時間: 00:00';
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const minutes = Math.floor(elapsedTime / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');
                timerElement.textContent = `経過時間: ${minutes}:${seconds}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function retry() {
            createTiles();
            resetTimer();
            startTimer();
        }

        function goToHome() {
            stopTimer();
            gameScreen.classList.remove('visible');
            homeScreen.classList.add('visible');
        }
    </script>
</body>
</html>
